AWSTemplateFormatVersion: 2010-09-09
Transform: AWS::Serverless-2016-10-31
Description: orchestration-pattern

Globals:
  Function:
    Runtime: java11
    MemorySize: 3072
    Timeout: 30
  Api:
    OpenApiVersion: '3.0.1'

Resources:
  #API Gateway
  CinemaAPIGateway:
    Type: AWS::Serverless::Api
    Properties:
      StageName: prod
      Name: CinemaAPIGateway

#Lambdas
  MediatorService:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: MediatorService
      Handler: com.ibercode.mediator.MediatorService::handleRequest
      CodeUri: target/sourceCode.zip
      Policies:
        - LambdaInvokePolicy:
            FunctionName: !Ref CinemaService
        - LambdaInvokePolicy:
            FunctionName: !Ref MovieService
      Events:
        ApiEvents:
          Type: Api
          Properties:
            Path: /cinema/{cinemaId}/movies
            Method: GET
            RestApiId: !Ref CinemaAPIGateway
      Environment:
        Variables:
          CINEMA_MS: !Ref CinemaService
          MOVIE_MS: !Ref MovieService

  CinemaService:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: CinemaService
      Handler: com.ibercode.cinema.CinemaService::handleRequest
      CodeUri: target/sourceCode.zip
      Environment:
        Variables:
          CINEMAS_TABLE: !Ref CinemasTable
      Policies:
        - LambdaInvokePolicy:
            FunctionName: !Ref MovieService
        - DynamoDBCrudPolicy:
            TableName: !Ref CinemasTable

  MovieService:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: MovieService
      Handler: com.ibercode.movie.MovieService::handleRequest
      CodeUri: target/sourceCode.zip
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MoviesTable
      Environment:
        Variables:
          MOVIES_TABLE: !Ref MoviesTable

  #DynamoDB Tables
  CinemasTable:
    Type: 'AWS::DynamoDB::Table'
    Properties:
      TableName: CinemasTable
      AttributeDefinitions:
        - AttributeName: cinemaId
          AttributeType: S
      KeySchema:
        - AttributeName: cinemaId
          KeyType: HASH
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5

  MoviesTable:
    Type: 'AWS::DynamoDB::Table'
    Properties:
      TableName: MoviesTable
      AttributeDefinitions:
        - AttributeName: movieId
          AttributeType: S
      KeySchema:
        - AttributeName: movieId
          KeyType: HASH
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5


Outputs:
  PaymentsEndpoint:
    Description: API Gateway Cinema Endpoint
    Value:
      Fn::Sub: https://${CinemaAPIGateway}.execute-api.${AWS::Region}.amazonaws.com/prod/cinema
